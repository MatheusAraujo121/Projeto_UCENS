<main class="cadastro-page">
  <div class="cadastro-container">
    <img src="assets/carp.jpg" class="bg-carpa" alt="carpa" />
    <h2>Editar Usuário #{{ userId }}</h2>

    <form *ngIf="userForm; else loadingOrError" [formGroup]="userForm" (ngSubmit)="onSubmit()">

      <p class="section-label"><em>Dados de Acesso</em></p>
      <div class="form-grid">
        <mat-form-field appearance="fill">
          <mat-label>Nome</mat-label>
          <input matInput formControlName="userName" placeholder="Ex: admin ou joao.silva" required>
          <mat-error *ngIf="userForm.get('userName')?.hasError('required')">
            Nome é obrigatório
          </mat-error>
          <mat-error *ngIf="userForm.get('userName')?.hasError('maxlength')">
             O nome não pode exceder 100 caracteres
          </mat-error>
        </mat-form-field>

        <mat-form-field appearance="fill">
          <mat-label>Email</mat-label>
          <input matInput formControlName="email" type="email" placeholder="Ex: email@email.com" required>
          <mat-error *ngIf="userForm.get('email')?.hasError('required')">
            Email é obrigatório
          </mat-error>
          <mat-error *ngIf="userForm.get('email')?.hasError('email')">
            Email inválido
          </mat-error>
           <mat-error *ngIf="userForm.get('email')?.hasError('maxlength')">
            O e-mail não pode exceder 150 caracteres
          </mat-error>
        </mat-form-field>
      </div>

      <p class="section-label"><em>Alterar Senha (Opcional)</em></p>
      <p class="note-label">Deixe os campos abaixo em branco para manter a senha atual.</p>

      <div class="form-grid">
        <mat-form-field appearance="fill">
          <mat-label>Nova Senha</mat-label>
          <input matInput formControlName="senha" [type]="hidePassword ? 'password' : 'text'">
          
          <button mat-icon-button matSuffix (click)="hidePassword = !hidePassword" [attr.aria-label]="'Ocultar senha'" type="button">
            <mat-icon>{{hidePassword ? 'visibility_off' : 'visibility'}}</mat-icon>
          </button>
          <mat-error *ngIf="userForm.get('senha')?.hasError('minlength')">
            A senha deve ter no mínimo 8 caracteres
          </mat-error>
        </mat-form-field>

        <mat-form-field appearance="fill">
          <mat-label>Confirmar Nova Senha</mat-label>
          <input matInput formControlName="confirmarSenha" [type]="hideConfirmPassword ? 'password' : 'text'">
          
          <button mat-icon-button matSuffix (click)="hideConfirmPassword = !hideConfirmPassword" [attr.aria-label]="'Ocultar senha'" type="button">
            <mat-icon>{{hideConfirmPassword ? 'visibility_off' : 'visibility'}}</mat-icon>
          </button>
          <mat-error *ngIf="userForm.get('confirmarSenha')?.hasError('required')">
            Confirmação é obrigatória ao definir nova senha
          </mat-error>
          <mat-error *ngIf="userForm.get('confirmarSenha')?.hasError('passwordMismatch')">
            As senhas não conferem
          </mat-error>
        </mat-form-field>
      </div>

      <div class="btns-bottom">
        <button mat-stroked-button class="btn-cancel" type="button" [routerLink]="['/view-user', userId]">
          <mat-icon>close</mat-icon>
          <span>Cancelar</span>
        </button>
        <button mat-stroked-button class="btn-submit" type="submit" [disabled]="userForm.invalid || isLoading">
          <mat-icon>radio_button_unchecked</mat-icon>
          <span>Salvar Alterações</span>
        </button>
      </div>
      
    </form>
  </div>
</main>

<ng-template #loadingOrError>
  <div *ngIf="isLoading" class="text-center py-5">
    <mat-spinner diameter="50" class="mx-auto"></mat-spinner>
    <p class="mt-3">Carregando usuário...</p>
  </div>
  <div *ngIf="!isLoading && !userForm" class="text-center py-5">
    <mat-icon color="warn" style="font-size: 50px; width: 50px; height: 50px;">error_outline</mat-icon>
    <h3 class="mt-3">Acesso Negado</h3>
    <p>O usuário que você está tentando editar não existe ou você não tem permissão.</p>
  </div>
</ng-template>
