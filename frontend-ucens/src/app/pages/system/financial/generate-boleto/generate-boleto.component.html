<main class="remessa-page">
  <div class="form-container">
    <img src="assets/carp.jpg" class="bg-carpa" alt="carpa" />
    <h2>Gerar Remessa</h2>

    <form [formGroup]="boletoForm" (ngSubmit)="onSubmit()">
      <div class="form-grid">

        <p class="section-label full-width"><em>1. Defina os dados gerais</em></p>
        <mat-form-field appearance="fill">
          <mat-label>Valor (R$)</mat-label>
          <input matInput type="number" formControlName="valorPadrao" placeholder="90.00">
           <mat-error *ngIf="boletoForm.get('valorPadrao')?.hasError('required')">O valor é obrigatório.</mat-error>
           <mat-error *ngIf="boletoForm.get('valorPadrao')?.hasError('min')">O valor deve ser maior que zero.</mat-error>
        </mat-form-field>
        <mat-form-field appearance="fill">
          <mat-label>Data de Vencimento</mat-label>
          <input matInput [matDatepicker]="pickerVencimento" formControlName="dataVencimento">
          <mat-datepicker-toggle matSuffix [for]="pickerVencimento"></mat-datepicker-toggle>
          <mat-datepicker #pickerVencimento></mat-datepicker>
          <mat-error *ngIf="boletoForm.get('dataVencimento')?.hasError('required')">A data de vencimento é obrigatória.</mat-error>
        </mat-form-field>

        <p class="section-label full-width"><em>2. Adicione os associados</em></p>
        
        <div class="search-actions full-width">
          <mat-form-field class="search-field" appearance="fill">
            <mat-label>Pesquisar e adicionar associado</mat-label>
            <input type="text"
                   placeholder="Digite o nome para buscar..."
                   matInput
                   [formControl]="associateCtrl"
                   [matAutocomplete]="auto"
                   #associateInput>
            <mat-autocomplete #auto="matAutocomplete" (optionSelected)="selected($event)">
              <mat-option *ngFor="let associate of filteredAssociates | async" [value]="associate">
                {{associate.nome}}
              </mat-option>
            </mat-autocomplete>
          </mat-form-field>

          <button mat-stroked-button type="button" class="btn-select-all" (click)="selectAllAssociates()">
            <mat-icon>select_all</mat-icon>
            Selecionar Todos
          </button>
        </div>

        <div class="full-width associate-list-container" *ngIf="boletosIndividuais.length > 0">
           <p class="section-label"><em>3. Ajuste os valores individuais (se necessário)</em></p>
           <div class="associate-list">
             <div *ngFor="let boleto of paginatedBoletos" class="associate-item">
                <span class="associate-name">{{ boleto.associate.nome }}</span>
                <mat-form-field appearance="outline" class="valor-individual">
                  <mat-label>Valor (R$)</mat-label>
                  <input matInput type="number" [(ngModel)]="boleto.valor" [ngModelOptions]="{standalone: true}">
                </mat-form-field>
                <button mat-icon-button color="warn" type="button" (click)="remove(boleto)" aria-label="Remover associado">
                  <mat-icon>delete</mat-icon>
                </button>
             </div>
           </div>
           
           <mat-paginator
              [length]="totalSize"
              [pageSize]="pageSize"
              [pageSizeOptions]="[5, 10, 25]"
              (page)="handlePageEvent($event)"
              aria-label="Select page" class="paginador">
            </mat-paginator>
        </div>
        
      </div>

      <div class="btns-bottom">
        <button mat-stroked-button class="btn-cancel" type="button" routerLink="/financial-dashboard">
          <mat-icon>close</mat-icon> Cancelar
        </button>
        <button mat-stroked-button class="btn-submit" type="submit" [disabled]="isLoading || boletosIndividuais.length === 0">
          <mat-icon>radio_button_unchecked</mat-icon>
          <span *ngIf="!isLoading">Gerar Remessa</span>
          <span *ngIf="isLoading">Gerando...</span>
        </button>
      </div>
    </form>
  </div>
</main>